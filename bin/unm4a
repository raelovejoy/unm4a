#!/usr/bin/env bash
set -euo pipefail

VERSION="0.1.0"

usage() {
  cat <<'EOF'
unm4a - extract FLAC-in-M4A into .flac (no re-encode), preserving attached cover art.

Usage:
  unm4a [options] [path ...]

If no path is given, uses the current directory.

Options:
  -r, --recursive       Recurse into subdirectories
  -o, --outdir DIR      Output directory (default: fixed_flac)
  -i, --inplace         Write .flac next to source files
      --remove-src      Remove source .m4a after successful conversion
  -n, --dry-run         Show what would happen
  -v, --verbose         Verbose output
  -h, --help            Show help
      --version         Show version
EOF
}

need_cmd() {
  command -v "$1" >/dev/null 2>&1 || {
    echo "Missing dependency: $1" >&2
    exit 1
  }
}

DRY_RUN=0
VERBOSE=0
RECURSIVE=0
INPLACE=0
REMOVE_SRC=0
OUTDIR="fixed_flac"

ARGS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    -r|--recursive) RECURSIVE=1; shift ;;
    -o|--outdir) OUTDIR="$2"; shift 2 ;;
    -i|--inplace) INPLACE=1; shift ;;
    --remove-src) REMOVE_SRC=1; shift ;;
    -n|--dry-run) DRY_RUN=1; shift ;;
    -v|--verbose) VERBOSE=1; shift ;;
    -h|--help) usage; exit 0 ;;
    --version) echo "unm4a $VERSION"; exit 0 ;;
    *) ARGS+=("$1"); shift ;;
  esac
done

need_cmd ffmpeg
need_cmd ffprobe

[[ ${#ARGS[@]} -eq 0 ]] && ARGS=(" .")

FILES=()

collect_files() {
  local path="$1"
  if [[ -f "$path" && "${path,,}" == *.m4a ]]; then
    FILES+=("$path")
  elif [[ -d "$path" ]]; then
    if [[ "$RECURSIVE" == "1" ]]; then
      while IFS= read -r -d '' f; do
        FILES+=("$f")
      done < <(find "$path" -type f -iname "*.m4a" -print0)
    else
      shopt -s nullglob
      for f in "$path"/*.m4a "$path"/*.M4A; do
        [[ -f "$f" ]] && FILES+=("$f")
      done
      shopt -u nullglob
    fi
  fi
}

for p in "${ARGS[@]}"; do
  collect_files "$p"
done

[[ ${#FILES[@]} -eq 0 ]] && { echo "No .m4a files found."; exit 1; }

for src in "${FILES[@]}"; do
  codec=$(ffprobe -v error -select_streams a:0     -show_entries stream=codec_name     -of default=noprint_wrappers=1:nokey=1 "$src" || true)

  if [[ "$codec" != "flac" ]]; then
    [[ "$VERBOSE" == "1" ]] && echo "Skipping (codec=$codec): $src"
    continue
  fi

  dir=$(dirname "$src")
  base=$(basename "$src" .m4a)

  if [[ "$INPLACE" == "1" ]]; then
    outdir="$dir"
  else
    outdir="$dir/$OUTDIR"
  fi

  dst="$outdir/$base.flac"

  if [[ "$DRY_RUN" == "1" ]]; then
    echo "Would convert: $src -> $dst"
    continue
  fi

  mkdir -p "$outdir"

  echo "Converting: $src"
  ffmpeg -hide_banner -loglevel error -i "$src"     -map 0:a:0 -c:a copy     -map 0:v:0 -c:v copy -disposition:v attached_pic     "$dst"

  if [[ "$REMOVE_SRC" == "1" ]]; then
    rm -f "$src"
  fi

done

echo "Done."
